<link rel="import" href="pws-behaviour.html">

<dom-module id="pws-location-time-button">
  <template>
    <style is="custom-style">
      .shifttime {
        display: inline-block;
        border: 1px solid grey;
      }

      .numShifts {
        text-align: center;
      }

      paper-button.time {
        margin: 0px;
        padding: 5px;
      }

      .timebutton {
        display: inline-block;
        margin: 2px;
        /*padding: 5px;*/
        border-radius: 3px;
        /*background-color: teal;*/
        border: 1px solid grey;
        cursor: pointer;
      }

      .timebutton .time {
        background-color: #9C27D0;
        color: #f3e5f5;
        padding: 3px;
        font-size: 14px;
      }

      .timebutton .shiftavailable {
        text-align: center;
      }

      .disabled {
        display: none;
      }

      paper-dialog {
        border-radius: 2px;
      }
    </style>

      <div class="timebutton" on-tap="openBookShiftDialog">
        <div class="time">[[shiftTime.displayName]]</div>
        <div class="shiftavailable">[[_computeAvailableShiftsDisplayName(shiftsAvailable)]]</div>
      </div>
      <firebase-document
          id="document"
          app-name="pws"
          path="[[editableShiftId]]"
          data="{{editableShift}}">
      </firebase-document>

      <paper-dialog id="bookshiftDialog" modal>
        <h2>Confirm Booking</h2>
        <p>
          Book this shift at [[location.name]], [[getPrintableDate(searchDate)]] at [[shiftTime.displayName]]?
        </p>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button on-tap="createShift" dialog-confirm autofocus>Book</paper-button>
        </div>
      </paper-dialog>
    <!-- </div> -->
  </template>
  <script>
    Polymer({
      is: 'pws-location-time-button',

      behaviors: [Polymer.PWSAppBehaviour],

      properties: {
        shifts: {
          type: Array,
          notify: true,
          observer: '_toggleTimeButton'
        },

        location: {
          type: Object
        },

        shiftTime: Object,

        shiftsNumber: {
          type: Number,
          value: 0
        },

        shiftsAvailable: {
          type: Number,
          computed: '_computeShiftsAvailable(shiftsNumber, location)',
          observer: '_toggleTimeButton',
          value: 0
        }
      },

      observers: [
        '_updateShiftNumber(shifts.splices)'
      ],

      _updateShiftNumber: function(newData, oldData) {
        if (newData) {
          var _this = this;
          this.shiftsNumber = newData.indexSplices[0].object.filter(function(shift) {return shift.time === _this.shiftTime.displayName && shift.location === _this.location.$key;}).length;
        } else {
          this.shiftsNumber = 0;
        }
      },

      _computeDisabled: function() {
        return this.shiftsAvailable == 0;
      },

      _computeShiftsAvailable: function(shiftsNumber, location) {
        return Number(location.maxPersons - this.shiftsNumber);
      },

      _toggleTimeButton: function() {
        var button = this.$$('.timebutton');

        var dateNow = moment().format('YYYYMMDD');
        var hourNow = moment().format('H');
        // console.log(this.shiftTime.displayName + ': ' +this.searchDate+'==='+dateNow+'? '+(this.searchDate == dateNow));
        if (Number(this.searchDate) === Number(dateNow) && Number(hourNow) >= Number(this.shiftTime.startTime)) {
          button.className += button.className ? ' disabled' : 'disabled';
        } else {
          var classes = button.className;
          button.className = classes.split(' ').filter(function(cls){return cls !== 'disabled';}).join(' ');
        }
      },

      _computeAvailableShiftsDisplayName: function(shiftsAvailable) {
        return (shiftsAvailable === 0) ? 'Full' : shiftsAvailable;
      },

      openBookShiftDialog: function() {
        this.$.bookshiftDialog.open();
      },

      createShift: function() {
        this.editableShiftId = null;
        this.editableShift.location = this.location.$key;
        this.editableShift.date = this.searchDate;
        this.editableShift.publishername = this.user.displayName;
        this.editableShift.user = this.user.uid;
        this.editableShift.date = this.editableShift.date;
        this.editableShift.time = this.shiftTime.displayName;
        this.editableShift.date_location = this.editableShift.date + '_' + this.editableShift.location;
        this.editableShift.approved = false;

        return this.$.document.save('/shifts/').then(function() {
          this.$.document.reset();
          // this.$$('#toast').open();
          window.location = '/#/myshifts';
        }.bind(this));
      }
    });
  </script>
</dom-module>
